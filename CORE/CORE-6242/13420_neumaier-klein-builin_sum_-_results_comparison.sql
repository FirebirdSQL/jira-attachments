-- https://wiki.tcl-lang.org/page/Kahan+compensated+summation+algorithm+and+Neumaier+variant+summation+algorithm%2C+numerical+analysis+

set bail on;
commit;
set transaction no wait;

recreate view v_compare_sums as select 1 x from rdb$database;
create or alter function nsum returns decfloat as begin end; -- neumaier sum
create or alter function ksum returns decfloat as begin end; -- klein sum
create or alter procedure sp_incr as begin end;
recreate sequence g;

recreate table test(
    id int generated by default as identity constraint pk_test primary key
    ,test_no int not null
    ,n_data decfloat not null
);

set term ^;
create or alter procedure sp_incr as
    declare c int;
begin
    c = gen_id(g,1);
end
^

create or alter function nsum(a_test_no int) returns decfloat as
   declare v decfloat;
   declare v_total decfloat = 0.0;
   declare v_compensator decfloat = 0.0;
   declare v_tmp decfloat;
begin
   for select n_data from test t where t.test_no = :a_test_no into v
   do begin
       v_tmp = v_total + v;
       if (abs(v_total) >= v) then
           -- low-order digits of input[i] are lost.
           v_compensator = v_compensator + (v_total - v_tmp) + v;
       else
           -- low-order digits of sum are lost.
           v_compensator = v_compensator + (v - v_tmp) + v_total;
       v_total = v_tmp;
   end
   return v_total + v_compensator;
end
^

create or alter function ksum(a_test_no int) returns decfloat as
   declare v decfloat;
   declare v_total decfloat = 0.0;
   declare v_compensator decfloat = 0.0;
   declare v_cs decfloat = 0.0;
   declare v_cc decfloat = 0.0;
   declare v_ccs decfloat = 0.0;
   declare v_tmp decfloat;
begin
   for select n_data from test t where t.test_no = :a_test_no into v
   do begin
       v_tmp = v_total + v;
       if (abs(v_total) >= v) then
           v_compensator = (v_total - v_tmp) + v;
       else
           v_compensator = (v - v_tmp) + v_total;

       v_total = v_tmp;
       v_tmp = v_cs + v_compensator;
       if ( abs(v_cs) >= abs(v_compensator) ) then
           v_cc = (v_cs - v_tmp) + v_compensator;
       else
           v_cc = (v_compensator - v_tmp) + v_cs;

       v_cs = v_tmp;
       v_ccs = v_ccs + v_cc;
   end
   return v_total + v_cs + v_ccs;
end
^
set term ;^
commit;

recreate view v_compare_sums as
select
     t.test_no
    ,built_in_sum
    ,nsum( t.test_no ) as neumaier_sum
    ,ksum( t.test_no ) as klein_kahan_sum
from (
    select t.test_no, sum(t.n_data) as built_in_sum
    from test t
    group by t.test_no
) t
;
commit;

-----------------------------------------------------

execute procedure sp_incr;
insert into test( test_no, n_data ) values(gen_id(g,0), 1);
insert into test( test_no, n_data ) values(gen_id(g,0), 1e33);
insert into test( test_no, n_data ) values(gen_id(g,0), 1);
insert into test( test_no, n_data ) values(gen_id(g,0),-1e33);

-----------------------------------------------------

execute procedure sp_incr;
insert into test( test_no, n_data ) values(gen_id(g,0), 1);
insert into test( test_no, n_data ) values(gen_id(g,0), 1e34);
insert into test( test_no, n_data ) values(gen_id(g,0), 1);
insert into test( test_no, n_data ) values(gen_id(g,0), -1e34);


-----------------------------------------------------

execute procedure sp_incr;
insert into test( test_no, n_data ) values(gen_id(g,0), 0.2 );
insert into test( test_no, n_data ) values(gen_id(g,0),  
 222222222222222222222222222222222
);

insert into test( test_no, n_data ) values(gen_id(g,0),  
 333333333333333333333333333333333
);

insert into test( test_no, n_data ) values(gen_id(g,0),  
 555555555555555555555555555555555
);

insert into test( test_no, n_data ) values(gen_id(g,0),  -0.3 );

insert into test( test_no, n_data ) values(gen_id(g,0), 
-222222222222222222222222222222222
);

insert into test( test_no, n_data ) values(gen_id(g,0), 
-777777777777777777777777777777777
);

insert into test( test_no, n_data ) values(gen_id(g,0), 
-111111111111111111111111111111111
);


-----------------------------------------------------

-- klein FAILS on this example:
-- ############################
execute procedure sp_incr;
insert into test( test_no, n_data ) values(gen_id(g,0),  
 222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
);

insert into test( test_no, n_data ) values(gen_id(g,0),  
 333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
);

insert into test( test_no, n_data ) values(gen_id(g,0),  
 55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
);

insert into test( test_no, n_data ) values(gen_id(g,0),  
-611111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110
);


-----------------------------------------------------

execute procedure sp_incr;
--insert into test( test_no, n_data ) values(gen_id(g,0), 0.2 );

insert into test( test_no, n_data ) values(gen_id(g,0),
-111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
);

insert into test( test_no, n_data ) values(gen_id(g,0), 
 5555555555555555555555555555555555
);

insert into test( test_no, n_data ) values(gen_id(g,0), 
 555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
);


insert into test( test_no, n_data ) values(gen_id(g,0), 
 222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
);

insert into test( test_no, n_data ) values(gen_id(g,0), 
 333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
);


--insert into test( test_no, n_data ) values(gen_id(g,0), -0.3 );

insert into test( test_no, n_data ) values(gen_id(g,0),
-222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
);

insert into test( test_no, n_data ) values(gen_id(g,0),
-777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
);


-----------------------------------------------------

execute procedure sp_incr;
insert into test( test_no, n_data ) values(gen_id(g,0), 0.2 );
insert into test( test_no, n_data ) values(gen_id(g,0),  
 2222222222222222222222222222222222
);

insert into test( test_no, n_data ) values(gen_id(g,0),  
 3333333333333333333333333333333333
);

insert into test( test_no, n_data ) values(gen_id(g,0),  
 5555555555555555555555555555555555
);

insert into test( test_no, n_data ) values(gen_id(g,0),  -0.3 );

insert into test( test_no, n_data ) values(gen_id(g,0), 
-2222222222222222222222222222222222
);

insert into test( test_no, n_data ) values(gen_id(g,0), 
-7777777777777777777777777777777777
);

insert into test( test_no, n_data ) values(gen_id(g,0), 
-1111111111111111111111111111111111
);

------------------------------------------------------

execute procedure sp_incr;
insert into test( test_no, n_data ) values(gen_id(g,0), 0.2 );
insert into test( test_no, n_data ) values(gen_id(g,0), 
222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
);

insert into test( test_no, n_data ) values(gen_id(g,0), 
333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
);

insert into test( test_no, n_data ) values(gen_id(g,0), 
555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
);

insert into test( test_no, n_data ) values(gen_id(g,0), -0.3 );

insert into test( test_no, n_data ) values(gen_id(g,0),
-222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222
);

insert into test( test_no, n_data ) values(gen_id(g,0),
-777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
);

insert into test( test_no, n_data ) values(gen_id(g,0),
-111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
);


commit;

--------------------------------------------

select * from v_compare_sums;
